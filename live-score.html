<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>JVP Sports Meet | Live Score</title>
      <style>
         * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         max-height: 999999px;
         }
         body {
         font-family: Arial, sans-serif;
         background: #000428;
         color: white;
         padding: 20px;
         }
         .dashboard-container {
         max-width: 1200px;
         margin: 0 auto;
         }
         h1 {
         text-align: center;
         margin-bottom: 38px;
         margin-top: 30px;
         color: white;
         font-size: 2rem;
         }
         h2 {
         text-align: center;
         margin-bottom: 30px;
         margin-top: 30px;
         color: white;
         font-size: 1.6rem;
         display: inline-flex;
         align-items: center;
         justify-content: center;
         width: 100%;
         gap: 10px;
         }
         h3 {
         margin: 14px 0;
         font-size: 1.2rem;
         text-align: center;
         }
         h1::after {
         content: '';
         display: inline-block;
         width: 10px;
         height: 10px;
         background-color: red;
         border-radius: 50%;
         margin-left: 10px;
         animation: blink 1.5s infinite;
         }
         @keyframes blink {
         0%, 100% {
         opacity: 1;
         }
         50% {
         opacity: 0.3;
         }
         }
         .tiles {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
         gap: 20px;
         margin-bottom: 40px;
         }
         .tile {
         padding: 20px;
         text-align: center;
         border-radius: 8px;
         font-size: 1.1rem;
         font-weight: bold;
         color: white;
         box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
         transition: transform 0.3s ease, box-shadow 0.3s ease;
         }
         .tile:hover {
         transform: translateY(-5px);
         box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
         }
         .tile.ruby {
         background-color: #e74c3c;
         }
         .tile.emerald {
         background-color: #27ae60;
         }
         .tile.sapphire {
         background-color: #2980b9;
         }
         .tile.topaz {
         background-color: #f39c12;
         }
         .tile span {
         font-size: 1.7rem;
         display: inline-block;
         margin: 7px 0;
         }
         .table-container {
         overflow-x: auto;
         background: white;
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
         margin-bottom: 20px;
         }
         table {
         width: 100%;
         border-collapse: collapse;
         color: #333;
         }
         thead {
         background: #004e92;
         color: white;
         }
         th,
         td {
         padding: 15px;
         text-align: center;
         border: 1px solid #fff;
         min-width: 125px;
         }
         tbody tr:nth-child(even) {
         /* background: #f9f9f9; */
         background: hsl(225, 50%, 96%)
         }
         tbody tr:hover {
         background: #f1f1f1;
         }
         table th:first-child,
         table td:first-child {
         text-align: left;
         }
         .btn-download {
         display: block;
         width: 200px;
         margin: 20px auto;
         padding: 10px 20px;
         font-size: 1.2rem;
         text-align: center;
         color: white;
         background: #27ae60;
         border: none;
         border-radius: 5px;
         cursor: pointer;
         box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
         transition: background 0.3s ease, transform 0.3s ease;
         }
         .btn-download:hover {
         background: #2ecc71;
         transform: translateY(-3px);
         box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
         }
         footer {
         text-align: center;
         margin-top: 28px;
         color: rgb(230,230,230);
         font-size: 1rem;
         padding-bottom: 24px;
         }
      </style>
   </head>
   <body>
      <div class="dashboard-container">
         <h1>JVP ANNUAL SPORTS MEET 2024</h1>
         <h2>Live Scorecard</h2>
         <!-- House Tiles -->
         <h3>Across All Class Groups</h3>
         <div class="tiles">
            <div class="tile ruby">Ruby:<br> <span id="ruby_total">0</span><br>Games won</div>
            <div class="tile emerald">Emerald:<br> <span id="emerald_total">0</span><br>Games won</div>
            <div class="tile sapphire">Sapphire:<br> <span id="sapphire_total">0</span><br>Games won</div>
            <div class="tile topaz">Topaz:<br> <span id="topaz_total">0</span><br>Games won</div>
         </div>
         <!-- House Tiles -->
         <h3>Nursery to Class 2</h3>
         <div class="tiles">
            <div class="tile ruby">Ruby:<br> <span id="ruby_nursery_to_class_2">0</span><br>Games won</div>
            <div class="tile emerald">Emerald:<br> <span id="emerald_nursery_to_class_2">0</span><br>Games won</div>
            <div class="tile sapphire">Sapphire:<br> <span id="sapphire_nursery_to_class_2">0</span><br>Games won</div>
            <div class="tile topaz">Topaz:<br> <span id="topaz_nursery_to_class_2">0</span><br>Games won</div>
         </div>
         <!-- House Tiles -->
         <h3>Class 3 to 5</h3>
         <div class="tiles">
            <div class="tile ruby">Ruby:<br> <span id="ruby_3_to_5">0</span><br>Games won</div>
            <div class="tile emerald">Emerald:<br> <span id="emerald_3_to_5">0</span><br>Games won</div>
            <div class="tile sapphire">Sapphire:<br> <span id="sapphire_3_to_5">0</span><br>Games won</div>
            <div class="tile topaz">Topaz:<br> <span id="topaz_3_to_5">0</span><br>Games won</div>
         </div>
         <!-- House Tiles -->
         <h3>Class 6 to 12</h3>
         <div class="tiles">
            <div class="tile ruby">Ruby:<br> <span id="ruby_6_to_12">0</span><br>Games won</div>
            <div class="tile emerald">Emerald:<br> <span id="emerald_6_to_12">0</span><br>Games won</div>
            <div class="tile sapphire">Sapphire:<br> <span id="sapphire_6_to_12">0</span><br>Games won</div>
            <div class="tile topaz">Topaz:<br> <span id="topaz_6_to_12">0</span><br>Games won</div>
         </div>
         <h3>Winners Table</h3>
         <!-- Winners Table -->
         <div class="table-container">
            <table id="winnersTable">
               <thead>
                  <tr>
                     <th>Game</th>
                     <th>Class Category</th>
                     <th>Winner 1</th>
                     <th>Winner 2</th>
                     <th>Winner 3</th>
                     <th>Winner House 1</th>
                     <th>Winner House 2</th>
                     <th>Winner House 3</th>
                  </tr>
               </thead>
               <tbody id="winnersTableBody">
                  <!-- Dynamic Rows Will Be Injected Here -->
               </tbody>
            </table>
         </div>
         <!-- Download Button -->
         <button class="btn-download" id="downloadBtn">Download CSV</button>
      </div>
      <footer>Crafted by Sourabh Sir</footer>
      <script type="module" src="./js/supabase-crud.js"></script>
      <script>
         let winners ;
         async function pollEntireData() {
         
         winners = await selectData(
         tableName = 'winners',
         fetchSingle = false,
         columns = '*',
         matchColumns = [],
         matchValues = [],
         orderByColumn = 'row_id',
         orderDirection = 'asc'
         );
         
         // Populate table rows dynamically
         winners.forEach(winner => {
           addNewRow(winner);
         });
         
         const winnerCounts = countWinnerHouses(winners);
         updateDashboard(winnerCounts);
         
         
         }
         
         
         // Function to download table data as CSV
         const downloadBtn = document.getElementById('downloadBtn');
         downloadBtn.addEventListener('click', () => {
           const table = document.getElementById('winnersTable');
           const rows = Array.from(table.rows);
         
           // Convert rows to CSV format
           const csvContent = rows.map(row => {
             const cells = Array.from(row.cells);
             return cells.map(cell => `"${cell.textContent}"`).join(',');
           }).join('\n');
         
           // Create a blob and download it
           const blob = new Blob([csvContent], { type: 'text/csv' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = 'winners_table.csv';
           a.click();
           URL.revokeObjectURL(url);
         });
         
         // function to count winner houses
         function countWinnerHouses(winners) {
         const winnerCounts = {};
         
         // Initialize the "Total" category
         winnerCounts["Total"] = { 'Ruby': 0, 'Topaz': 0, 'Emerald': 0, 'Sapphire': 0 };
         
         // Loop through each winner entry
         winners.forEach(entry => {
         const { classcategory, winnerhouse1 } = entry;
         
         // Initialize the class category in the result object if not already present
         if (!winnerCounts[classcategory]) {
           winnerCounts[classcategory] = { 'Ruby': 0, 'Topaz': 0, 'Emerald': 0, 'Sapphire': 0 };
         }
         
         // Increment the count for the house in the class category
         if (winnerCounts[classcategory][winnerhouse1] !== undefined) {
           winnerCounts[classcategory][winnerhouse1]++;
         }
         
         // Increment the count for the house in the "Total" category
         if (winnerCounts["Total"][winnerhouse1] !== undefined) {
           winnerCounts["Total"][winnerhouse1]++;
         }
         });
         
         return winnerCounts;
         }
         
         // function to update the dashboard (house winner counts)
         function updateDashboard(winnerCounts) {
         // Loop through each class category in the winnerCounts object
         for (const classcategory in winnerCounts) {
         // Get the house counts for the current category
         const houseCounts = winnerCounts[classcategory];
         
         // Loop through each house in the houseCounts object
         for (const house in houseCounts) {
           // Format the class category and house into the ID pattern
           const formattedCategory = classcategory.toLowerCase().replace(/ /g, '_');
           const id = `${house.toLowerCase()}_${formattedCategory}`;
         
           // Find the HTML element by the ID
           const element = document.getElementById(id);
         
           // If the element exists, update its content
           if (element) {
             element.textContent = houseCounts[house];
           } else {
             console.warn(`Element with ID "${id}" not found.`);
           }
         }
         }
         }
         
         
         function addNewRow(winner) {
           const winnersTableBody = document.getElementById('winnersTableBody');
         
           const row = document.createElement('tr');
           row.id = 'row' + winner.row_id;
           row.innerHTML = `
             <td>${winner.game}</td>
             <td>${winner.classcategory}</td>
             <td>${winner.winner1}</td>
             <td>${winner.winner2}</td>
             <td>${winner.winner3}</td>
             <td>${winner.winnerhouse1}</td>
             <td>${winner.winnerhouse2}</td>
             <td>${winner.winnerhouse3}</td>
           `;
           winnersTableBody.appendChild(row);
         
         }
         
         
         function updateExistingRow(winner) {
         
           const row = document.getElementById('row' + winner.row_id);
           
           row.innerHTML = `
             <td>${winner.game}</td>
             <td>${winner.classcategory}</td>
             <td>${winner.winner1}</td>
             <td>${winner.winner2}</td>
             <td>${winner.winner3}</td>
             <td>${winner.winnerhouse1}</td>
             <td>${winner.winnerhouse2}</td>
             <td>${winner.winnerhouse3}</td>
           `;
         
         }
         
         
         function updateWinner(rowID, newWinnerData) {
         // Find the index of the object with the matching row_id
         const index = winners.findIndex(winner => winner.row_id === rowID);
         
         // If the object is found, update it with the newWinnerData
         if (index !== -1) {
             winners[index] = { ...winners[index], ...newWinnerData };
         } else {
             console.log(`Row with ID ${rowID} not found.`);
         }
         }
         
         function handleLiveUpdate(payload) {
         if(payload.eventType === 'INSERT') {
         winners.push(payload.new);
         addNewRow(payload.new);
         }
         else if(payload.eventType === 'UPDATE') {
         updateWinner(payload.new.row_id, payload.new);
         updateExistingRow(payload.new);
         }
         
         const winnerCounts = countWinnerHouses(winners);
         updateDashboard(winnerCounts);
         
         }
         
         window.addEventListener('load', function () {
         pollEntireData();
         const subscription = subscribeToTable('winners', handleLiveUpdate);
         });
         
      </script>
   </body>
</html>
